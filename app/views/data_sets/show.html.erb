<%= link_to 'Back', data_sets_path %>
<h1>Data Set</h1>
<p id="notice"><%= notice %></p>
<%= render 'full_display', :data_set => @data_set %>
<br />
<div <%= @jquery.set_id( "data_set_tabs", :tabs  ) %> style="height:auto;min-height:100px" >
	<ul>
		<li><a href="#data_set_field_stats">Field Stats</a></li>
		<li><a href="#keys">Keys</a></li>
		<li><a href="#revisions">Revisions</a></li>
	</ul>
	<div <%= @jquery.set_id( "data_set_field_stats", :accordion  ) %> style="height:auto" >
		<% @data_set.fields.each do |field| %>
			<h3><%= field.name %></h3>
			<div id="<%= field.name %>_stats" >
				<ul>
					<li><b>Cells:</b> <%= field.cells.size %></li>
					<% unique_cell_values = field.cells.map(&:string).uniq %>
					<li><b># Unique Cells:</b> <%= unique_cell_values.size %></li>
					<li><b>Unique Values:</b> <%= unique_cell_values %></li>
				</ul>
			</div>
		<% end %>
	</div>
	<div id="keys" style="height:auto;min-height:100px"  >
		<div <%= @jquery.set_id( "key_options", :accordion  ) %> style="height:auto;min-height:100px" >
			<h3>Current Keys</h3>
			<div <%= @jquery.set_id( "current_keys", :accordion  ) %> style="height:auto;min-height:100px" >
				<%= "No Keys Defined Yet" if @data_set.keys.size == 0  %>
				<% @data_set.keys.each do |key| %>
					<h3><%= key.name %></h3>
					<div id="<%= key.name %>_key_stats" style="height:auto;min-height:100px" >
						<% key_records = key.get_records %> <br />
						<% field_names = key.key_fields.collect { |key_field| key_field.field.name } %>
						Fields: <%= field_names.join(",") %> <br />
						<div id="<%= "#{key.name}_accordian" %>" >
							Unique Record Keys: <%= key_records.size %> <br />
							Duplicate Keys: <br />
							<% key_records.each do |key_value,dups| %> 
								<% next if dups.size == 1 %>
								<%= "#{key_value}: #{dups.size} records" %> <br />
							<% end %>
						</div>
					</div>
				<% end %>
			</div>
			<h3>Create New Key (create partial)</h3>
			<div id="new_key" style="height:auto;min-height:100px" >
				<%= form_for( [@data_set, @data_set.keys.build] ) do |f| %>
					<div class="field">
						<%= f.label :name %><br />
						<%= f.text_field :name %>
					</div>
					<ul>
						<% @data_set.fields.each do |field| %>
							<li>
							<%= check_box_tag 'field_ids[]', field.id -%>
							<%= field.name -%>
							</li>
						<% end %>
					</ul>
					<div class="actions">
						<%= f.submit %>
					</div>
				<% end %>
			</div>
		</div>
	</div>
	<div <%= @jquery.set_id( "revisions", :accordion ) %> style="height:auto" >
		<% @revisions.each do |revision| %>
			<%= render 'full_display', :data_set => @data_set, :revision => revision %>
		<% end %>
	</div>

</div>


